<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Emotion & Dopamine Radio</title>
  <style>
    body {
      background: radial-gradient(circle at top, #141414, #000);
      color: #fff;
      font-family: "Poppins", sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }
    h1 {
      font-size: 2em;
      margin-top: 2rem;
    }
    audio {
      width: 90%;
      max-width: 400px;
      margin: 1rem auto;
      display: block;
      border-radius: 8px;
      outline: none;
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
    }
    #globe-container {
      width: 400px;
      height: 400px;
      margin: 2rem auto;
    }
    #location {
      font-size: 1rem;
      color: #aaa;
      margin-bottom: 1rem;
    }
    #song {
      font-size: 1.1rem;
      margin-top: 1.5rem;
      font-weight: bold;
    }
    #lyrics {
      font-size: 0.9rem;
      white-space: pre-wrap;
      line-height: 1.4;
      max-width: 90%;
      margin: 1rem auto 3rem;
      color: #ccc;
    }
    footer {
      font-size: 0.8em;
      color: #666;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <h1>üéß Emotion & Dopamine Radio</h1>
  <p id="location">Detectando sua cidade...</p>
  <audio id="radio" src="https://stream.zeno.fm/r8s232x3xg0uv" controls autoplay></audio>
  <div id="globe-container"></div>
  <p id="song">Carregando m√∫sica...</p>
  <div id="lyrics"></div>
  <footer>Powered by Emotion & Dopamine Radio üåç</footer>

  <!-- Three.js para o globo -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

  <script>
    // ===== LOCALIZA√á√ÉO =====
    fetch("https://ipapi.co/json/")
      .then((res) => res.json())
      .then((data) => {
        document.getElementById("location").textContent =
          `Voc√™ est√° ouvindo de ${data.city}, ${data.region}, ${data.country_name}.`;
        localStorage.setItem("ultimaCidade", data.city);
        addCityToLocalList(data.city);
        showCityOnGlobe(data.latitude, data.longitude);
      })
      .catch(() => {
        document.getElementById("location").textContent =
          "N√£o foi poss√≠vel detectar sua cidade.";
      });

    // ===== GLOBO 3D =====
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    const container = document.getElementById("globe-container");
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);

    const sphere = new THREE.Mesh(
      new THREE.SphereGeometry(2, 64, 64),
      new THREE.MeshBasicMaterial({
        map: new THREE.TextureLoader().load(
          "https://upload.wikimedia.org/wikipedia/commons/8/83/Equirectangular_projection_SW.jpg"
        ),
      })
    );
    scene.add(sphere);
    camera.position.z = 4;

    const markerGeometry = new THREE.SphereGeometry(0.03, 16, 16);
    const markerMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 });
    const marker = new THREE.Mesh(markerGeometry, markerMaterial);
    scene.add(marker);

    function showCityOnGlobe(lat, lon) {
      const phi = (90 - lat) * (Math.PI / 180);
      const theta = (lon + 180) * (Math.PI / 180);
      marker.position.x = 2 * Math.sin(phi) * Math.cos(theta);
      marker.position.y = 2 * Math.cos(phi);
      marker.position.z = 2 * Math.sin(phi) * Math.sin(theta);
    }

    function animate() {
      requestAnimationFrame(animate);
      sphere.rotation.y += 0.002;
      renderer.render(scene, camera);
    }
    animate();

    function addCityToLocalList(city) {
      const cidades = JSON.parse(localStorage.getItem("cidades")) || [];
      if (!cidades.includes(city)) {
        cidades.push(city);
        localStorage.setItem("cidades", JSON.stringify(cidades));
      }
    }

    // ===== M√öSICA ATUAL + LETRA =====
    async function fetchCurrentSong() {
      try {
        const res = await fetch("https://api.zeno.fm/mounts/metadata/subscribe/r8s232x3xg0uv");
        const data = await res.json();
        const title = data.title || "M√∫sica n√£o identificada";
        document.getElementById("song").textContent = `Tocando agora: ${title}`;
        fetchLyrics(title);
      } catch (e) {
        document.getElementById("song").textContent = "N√£o foi poss√≠vel carregar a faixa atual.";
      }
    }

    async function fetchLyrics(title) {
      const lyricsEl = document.getElementById("lyrics");
      lyricsEl.textContent = "Carregando letra...";
      try {
        const [artist, song] = title.split(" - ");
        const res = await fetch(`https://api.lyrics.ovh/v1/${artist}/${song}`);
        const data = await res.json();
        lyricsEl.textContent = data.lyrics || "Letra n√£o encontrada.";
      } catch {
        lyricsEl.textContent = "Letra n√£o encontrada.";
      }
    }

    // Atualiza a cada 30 segundos
    fetchCurrentSong();
    setInterval(fetchCurrentSong, 30000);

    // Autoplay fallback
    const radio = document.getElementById("radio");
    document.addEventListener("click", () => {
      if (radio.paused) radio.play();
    });
  </script>
</body>
</html>
